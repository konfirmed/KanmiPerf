{"version":3,"file":"kanmi-perf.esm.js","sources":["../src/kanmi-perf.js"],"sourcesContent":["import { KanmiPerfConfig } from './config.js';\nconst KanmiPerf = () => {\n    const perf = {};\n  \n    /** Utility Logger **/\n    perf.log = (type, issues) => {\n      console.groupCollapsed(`[KanmiPerf 🚀] ⚠️ ${type}`);\n      issues.forEach(issue => console.log(`- ${issue}`));\n      console.groupEnd();\n    };\n  \n    /** DOM Analysis (Detect images missing explicit dimensions causing CLS) **/\n    perf.domAnalysis = () => {\n      const imgs = [...document.querySelectorAll('img:not([width]), img:not([height])')];\n      if (imgs.length) {\n        perf.log('DOM Issues', [\n          `${imgs.length} image${imgs.length > 1 ? 's' : ''} missing dimensions (causes CLS)`\n        ]);\n      }\n    };\n  \n    /** <head> Analysis (Check for render-blocking scripts) **/\n    perf.headAnalysis = () => {\n      const headScripts = [...document.head.querySelectorAll('script[src]')];\n      const blockingScripts = headScripts.filter(script => !script.defer && !script.async);\n      if (blockingScripts.length) {\n        perf.log('<head> Issues', [\n          `${blockingScripts.length} blocking script${blockingScripts.length > 1 ? 's' : ''} without async/defer`,\n          ...blockingScripts.map(script => `Suggest moving ${script.src} lower or load it with async/defer`)\n        ]);\n      }\n    };\n  \n    /** Third-party Script Detection **/\n    perf.thirdPartyAnalysis = () => {\n      const host = location.hostname;\n      const scripts = [...document.scripts].filter(s => s.src && !s.src.includes(host));\n      const syncScripts = scripts.filter(s => !s.defer && !s.async);\n      if (syncScripts.length) {\n        perf.log('Third-party Issues', syncScripts.map(script => {\n          const hostname = new URL(script.src).hostname;\n          return `${hostname} synchronously loaded, delays rendering → Suggest loading async/defer or using Partytown`;\n        }));\n      }\n    };\n  \n    /** Long Task Monitoring (using PerformanceObserver API) **/\n    perf.monitorLongTasks = () => {\n      if (!('PerformanceObserver' in window)) return;\n      const observer = new PerformanceObserver(list => {\n        list.getEntries().forEach(entry => {\n          if (entry.duration > 125) {\n            perf.log('Long Task', [\n              `Duration: ${Math.round(entry.duration)}ms`,\n              `→ Consider breaking into smaller tasks or deferring heavy JS`\n            ]);\n          }\n        });\n      });\n      observer.observe({ type: 'longtask', buffered: true });\n    };\n  \n    /** Long Animation Frame (LoAF) Monitoring **/\n    perf.monitorLoAF = () => {\n      if (!PerformanceObserver.supportedEntryTypes.includes('long-animation-frame')) return;\n      const observer = new PerformanceObserver(list => {\n        list.getEntries().forEach(entry => {\n          const { duration, blockingDuration, renderTime, styleAndLayoutDuration } = entry;\n          const safeNumber = (num) => Number.isFinite(num) ? Math.round(num) : 'N/A';\n          \n          let messages = [\n            `Duration: ${safeNumber(duration)}ms, Blocking: ${safeNumber(blockingDuration)}ms`,\n            `Render: ${safeNumber(renderTime)}ms, Layout: ${safeNumber(styleAndLayoutDuration)}ms`\n          ];\n          // Inform when render/layout metrics are unavailable.\n          if (renderTime === undefined || styleAndLayoutDuration === undefined) {\n            messages.push('Note: Browser does not support detailed render/layout metrics for LoAF entries.');\n          }\n          messages.push('→ Investigate heavy scripts or CSS causing recalculations');\n          \n          perf.log('LoAF Detected', messages);\n        });\n      });\n      observer.observe({ type: 'long-animation-frame', buffered: true });\n    };\n  \n    /** INP Correlation (Basic Event Monitoring for slow interactions) **/\n    perf.monitorINP = () => {\n      if (!PerformanceObserver.supportedEntryTypes.includes('event')) return;\n      const observer = new PerformanceObserver(list => {\n        list.getEntries().forEach(entry => {\n          if (entry.duration > 300) { // indicative of slow INP\n            perf.log('INP Interaction Issue', [\n              `${entry.name} delayed interaction response by ${Math.round(entry.duration)}ms`,\n              `→ Consider simplifying event handlers or deferring tasks`\n            ]);\n          }\n        });\n      });\n      observer.observe({ type: 'event', durationThreshold: 300, buffered: true });\n    };\n  \n    /** Largest Contentful Paint (LCP) Monitoring **/\n    perf.monitorLCP = () => {\n      if (!PerformanceObserver.supportedEntryTypes.includes('largest-contentful-paint')) return;\n      let lcpEntry;\n      const observer = new PerformanceObserver(list => {\n        // Keep updating the latest LCP entry.\n        list.getEntries().forEach(entry => lcpEntry = entry);\n      });\n      observer.observe({ type: 'largest-contentful-paint', buffered: true });\n      \n      // Log LCP when page visibility changes (common practice to capture the final value)\n      document.addEventListener('visibilitychange', () => {\n        if (document.visibilityState === 'hidden' && lcpEntry) {\n          perf.log('LCP', [\n            `Largest Contentful Paint: ${lcpEntry.renderTime ? Math.round(lcpEntry.renderTime) : Math.round(lcpEntry.loadTime)}ms`,\n            `Element: ${lcpEntry.element ? lcpEntry.element.tagName : 'N/A'}`,\n            `→ Optimize images, text, and video content for faster loading`\n          ]);\n        }\n      });\n    };\n  \n    /** Cumulative Layout Shift (CLS) Monitoring **/\n    perf.monitorCLS = () => {\n      if (!PerformanceObserver.supportedEntryTypes.includes('layout-shift')) return;\n      let clsValue = 0;\n      const observer = new PerformanceObserver(list => {\n        list.getEntries().forEach(entry => {\n          // Only count layout shifts not triggered by user input.\n          if (!entry.hadRecentInput) {\n            clsValue += entry.value;\n          }\n        });\n      });\n      observer.observe({ type: 'layout-shift', buffered: true });\n      \n      // Log CLS on page hide\n      document.addEventListener('visibilitychange', () => {\n        if (document.visibilityState === 'hidden') {\n          perf.log('CLS', [\n            `Cumulative Layout Shift: ${clsValue.toFixed(2)}`,\n            `→ Add size attributes to images and videos, reserve space for ads/embeds, and avoid dynamic content injection`\n          ]);\n        }\n      });\n    };\n  \n    /** Run All Analyses Manually **/\n    perf.run = () => {\n      perf.domAnalysis();\n      perf.headAnalysis();\n      perf.thirdPartyAnalysis();\n      perf.monitorLongTasks();\n      perf.monitorLoAF();\n      perf.monitorINP();\n      perf.monitorLCP();\n      perf.monitorCLS();\n    };\n  \n    /** Initialization: Run on page load or immediately if already loaded **/\n    perf.init = () => {\n      if (document.readyState === 'complete') {\n        // If the page is already loaded, run analysis immediately.\n        perf.run();\n      } else {\n        window.addEventListener('load', perf.run);\n      }\n    };\n  \n  return perf;\n};\n\nconst KanmiPerfInstance = KanmiPerf();\nexport default KanmiPerfInstance;"],"names":["KanmiPerfInstance","perf","type","issues","console","groupCollapsed","forEach","issue","log","groupEnd","imgs","document","querySelectorAll","length","blockingScripts","head","filter","script","defer","async","map","src","host","location","hostname","syncScripts","scripts","s","includes","URL","window","PerformanceObserver","list","getEntries","entry","duration","Math","round","observe","buffered","supportedEntryTypes","blockingDuration","renderTime","styleAndLayoutDuration","safeNumber","num","Number","isFinite","messages","undefined","push","name","durationThreshold","lcpEntry","addEventListener","visibilityState","loadTime","element","tagName","clsValue","hadRecentInput","value","toFixed","domAnalysis","headAnalysis","thirdPartyAnalysis","monitorLongTasks","monitorLoAF","monitorINP","monitorLCP","monitorCLS","readyState","run","KanmiPerf"],"mappings":"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"}